// -*-C++-*-

/* Purpose: NCO/ncap2 script to process and calibrate Terraref exposure data

   Documentation:
   https://docs.google.com/document/d/1w_zHHlrPVKsy1mnW9wrVzAU2edVqZH8i1IZa5BZxVpo/edit#heading=h.jjfbhbos05cc # Calibration employed since 20160908
   https://github.com/terraref/computing-pipeline/issues/88 # Calibration employed until 20160908

   Usage:
   ncap2 -v -O -S ~/terraref/computing-pipeline/scripts/hyperspectral/hyperspectral_calibration.nco ${DATA}/terraref/whiteReference_raw.nc ~/foo.nc */

// Declare flags as RAM variables or they will clutter output file
*flg_tst=1s; // [flg] Test mode
*flg_prd=0s; // [flg] Production mode

// Run in test or production mode?
*flg_typ=flg_prd; // [enm] Run type

// Defaults for values not provided on command-line
if(!exists(clb_nbr)) *clb_nbr=73; // [nbr] Calibration number

// Add georeferenced coordinates
// Store x and y in double-precision in case we use lat/lon
// If stored as meters from image or gantry corner, then single-precision would be sufficient
x=array(0.0,0.001,$x);
x@long_name="North-south offset from start position";
x@units="meter";
x@algorithm="CSZ implemented these fake data to be replaced by real formula once available.";

y=array(0.0,0.00098526434004512529576754637665,$y);
y@long_name="East-west offset from start position";
y@units="meter";
y@algorithm="Based on https://github.com/terraref/computing-pipeline/issues/144. y is defined as 0.9853 mm per pixel. Exact number is 0.98526434004512529576754637665 mm.";

// Change Hyperspectral Imager wavelengths from nm to m (SI)
wavelength*=1.0e-9; // [m]
wavelength@standard_name="radiation_wavelength";
wavelength@units="meter";

// [W m-2 m-1] Downwelling spectral irradiance
// 20160908 This is a placeholder for irradiance on the hyperspectral grid
// Currently no instrument measures this
// The only irradiance measured in by the Environmental Logger, which has a different (and non-overlapping) spectral grid
//flx_dwn[wavelength]=2.0e9f;
//flx_dwn@long_name="Downwelling spectral irradiance";
//flx_dwn@standard_name="surface_downwelling_radiative_flux_per_unit_wavelength_in_air";
//flx_dwn@units="watt meter-2 meter-1";

/* Calibrate hyperspectral image from raw counts to reflectance
   Optimal calibration would have this equal 2^16-1 in each channel for a perfectly white reflector
   This parameter depends solely on the bit-resolution of the camera (currently 16 bits) */
*exposure_theoretical_maximum=ushort(2^16-1); // [cnt]

/* Assume spectral reference target employed is "white" reference sheet that reflects all wavelengths with 95% efficiency
   (Some) Documentation for spectralon reference targets at
   https://github.com/terraref/reference-data/issues/36
   https://github.com/terraref/reference-data/issues/53

   20160927: fxm replace guesstimate with actual, wavelength-dependent calibrated reflectance below */
*factory_calibrated_reflectance_guesstimate=0.95f; // [frc]

// [nbr] Number of wavelengths in factory calibration of spectralon reference
*wvl_clb_nbr=2251;
defdim("wvl_clb",wvl_clb_nbr);
wvl_clb[wvl_clb]=0.0f; // [m]
wvl_clb@long_name="Wavelength of factory calibration";
wvl_clb@standard_name="sensor_band_central_radiation_wavelength";
wvl_clb@units="meter";
wvl_clb@provenance="Factory calibration of SphereOptics part #99AA02-0316-4214 received from @serbinsh Shawn Serbin <sserbin@bnl.gov>. Data are 2251 absolute calibrated reflectances at 1 nm resolution from 250--2500 nm. More information at https://github.com/terraref/reference-data/issues/53#issuecomment-249925142";
wvl_clb=array(250.0,1.0,$wvl_clb);
// Change calibration wavelengths from nm to m (SI)
wvl_clb*=1.0e-9; // [m]

/* 20160927: Factory calibration of SphereOptics part #99AA02-0316-4214 received from @serbinsh Shawn Serbin <sserbin@bnl.gov>
   Data are 2251 absolute calibrated reflectances at 1 nm resolution from 250--2500 nm
   More information at https://github.com/terraref/reference-data/issues/53#issuecomment-249925142 */
*factory_calibrated_reflectance[wvl_clb]={ // [frc] 10 wavelengths per line, 2251 total
0.9618,0.9622,0.9633,0.9638,0.9645,0.9641,0.9647,0.9644,0.9650,0.9646,
0.9648,0.9655,0.9659,0.9668,0.9661,0.9669,0.9672,0.9665,0.9671,0.9678,
0.9672,0.9659,0.9660,0.9673,0.9682,0.9676,0.9690,0.9695,0.9705,0.9705,
0.9693,0.9702,0.9703,0.9707,0.9721,0.9728,0.9738,0.9729,0.9748,0.9754,
0.9765,0.9759,0.9755,0.9769,0.9778,0.9779,0.9783,0.9781,0.9802,0.9796,
0.9796,0.9790,0.9805,0.9800,0.9792,0.9813,0.9812,0.9822,0.9825,0.9818,
0.9831,0.9828,0.9823,0.9829,0.9820,0.9830,0.9825,0.9827,0.9847,0.9866,
0.9873,0.9884,0.9871,0.9882,0.9886,0.9883,0.9873,0.9875,0.9885,0.9874,
0.9871,0.9882,0.9878,0.9881,0.9884,0.9887,0.9886,0.9891,0.9889,0.9882,
0.9877,0.9882,0.9892,0.9889,0.9891,0.9889,0.9885,0.9884,0.9888,0.9889,
0.9893,0.9892,0.9887,0.9885,0.9890,0.9895,0.9887,0.9885,0.9891,0.9892,
0.9892,0.9889,0.9886,0.9893,0.9893,0.9897,0.9896,0.9901,0.9901,0.9898,
0.9906,0.9911,0.9908,0.9900,0.9909,0.9925,0.9924,0.9911,0.9903,0.9896,
0.9889,0.9889,0.9897,0.9891,0.9885,0.9905,0.9912,0.9911,0.9911,0.9909,
0.9907,0.9903,0.9904,0.9903,0.9905,0.9912,0.9913,0.9914,0.9912,0.9920,
0.9918,0.9913,0.9912,0.9910,0.9910,0.9907,0.9910,0.9918,0.9922,0.9913,
0.9909,0.9912,0.9913,0.9919,0.9916,0.9910,0.9915,0.9915,0.9912,0.9916,
0.9919,0.9917,0.9914,0.9911,0.9916,0.9916,0.9920,0.9920,0.9915,0.9913,
0.9918,0.9920,0.9917,0.9916,0.9915,0.9918,0.9915,0.9912,0.9913,0.9913,
0.9915,0.9919,0.9920,0.9920,0.9919,0.9915,0.9910,0.9910,0.9912,0.9907,
0.9911,0.9913,0.9913,0.9921,0.9917,0.9916,0.9916,0.9915,0.9913,0.9909,
0.9912,0.9914,0.9917,0.9912,0.9914,0.9912,0.9912,0.9913,0.9914,0.9919,
0.9917,0.9916,0.9914,0.9926,0.9924,0.9924,0.9925,0.9924,0.9928,0.9928,
0.9928,0.9928,0.9921,0.9923,0.9922,0.9919,0.9916,0.9916,0.9917,0.9918,
0.9921,0.9921,0.9917,0.9917,0.9919,0.9917,0.9919,0.9919,0.9913,0.9919,
0.9919,0.9915,0.9917,0.9920,0.9919,0.9916,0.9922,0.9921,0.9925,0.9920,
0.9922,0.9923,0.9925,0.9928,0.9925,0.9926,0.9926,0.9927,0.9925,0.9924,
0.9924,0.9928,0.9931,0.9925,0.9933,0.9929,0.9925,0.9933,0.9927,0.9929,
0.9927,0.9932,0.9931,0.9928,0.9933,0.9926,0.9928,0.9934,0.9934,0.9928,
0.9926,0.9924,0.9925,0.9929,0.9925,0.9929,0.9930,0.9929,0.9927,0.9928,
0.9930,0.9927,0.9929,0.9927,0.9923,0.9931,0.9923,0.9931,0.9926,0.9930,
0.9929,0.9926,0.9924,0.9920,0.9927,0.9931,0.9928,0.9930,0.9929,0.9925,
0.9930,0.9927,0.9927,0.9927,0.9924,0.9927,0.9931,0.9934,0.9925,0.9927,
0.9926,0.9929,0.9924,0.9922,0.9927,0.9928,0.9928,0.9924,0.9925,0.9927,
0.9927,0.9928,0.9927,0.9928,0.9931,0.9933,0.9929,0.9927,0.9926,0.9927,
0.9927,0.9924,0.9925,0.9928,0.9929,0.9926,0.9926,0.9929,0.9927,0.9930,
0.9924,0.9930,0.9930,0.9928,0.9925,0.9923,0.9928,0.9932,0.9931,0.9930,
0.9924,0.9928,0.9932,0.9928,0.9929,0.9928,0.9924,0.9924,0.9928,0.9926,
0.9923,0.9924,0.9924,0.9923,0.9928,0.9926,0.9926,0.9926,0.9927,0.9923,
0.9922,0.9926,0.9927,0.9928,0.9926,0.9928,0.9928,0.9925,0.9925,0.9928,
0.9930,0.9925,0.9922,0.9925,0.9926,0.9925,0.9922,0.9923,0.9925,0.9928,
0.9929,0.9932,0.9928,0.9928,0.9930,0.9926,0.9925,0.9925,0.9930,0.9927,
0.9922,0.9922,0.9927,0.9932,0.9928,0.9925,0.9925,0.9928,0.9931,0.9932,
0.9927,0.9925,0.9926,0.9925,0.9921,0.9923,0.9929,0.9928,0.9925,0.9930,
0.9931,0.9926,0.9928,0.9929,0.9930,0.9928,0.9926,0.9931,0.9933,0.9929,
0.9926,0.9922,0.9924,0.9927,0.9929,0.9930,0.9924,0.9925,0.9930,0.9932,
0.9928,0.9923,0.9929,0.9929,0.9922,0.9922,0.9924,0.9922,0.9926,0.9928,
0.9925,0.9923,0.9927,0.9926,0.9916,0.9923,0.9927,0.9923,0.9920,0.9921,
0.9922,0.9924,0.9924,0.9927,0.9924,0.9924,0.9920,0.9913,0.9924,0.9917,
0.9920,0.9928,0.9928,0.9928,0.9918,0.9922,0.9919,0.9922,0.9916,0.9921,
0.9922,0.9923,0.9925,0.9919,0.9918,0.9925,0.9927,0.9923,0.9922,0.9921,
0.9921,0.9929,0.9932,0.9929,0.9925,0.9925,0.9914,0.9919,0.9920,0.9919,
0.9930,0.9930,0.9931,0.9921,0.9918,0.9912,0.9919,0.9917,0.9916,0.9922,
0.9916,0.9915,0.9926,0.9925,0.9923,0.9919,0.9917,0.9918,0.9929,0.9931,
0.9919,0.9927,0.9920,0.9930,0.9906,0.9917,0.9913,0.9924,0.9937,0.9924,
0.9904,0.9924,0.9931,0.9932,0.9912,0.9926,0.9913,0.9912,0.9919,0.9922,
0.9922,0.9925,0.9924,0.9922,0.9916,0.9921,0.9909,0.9927,0.9918,0.9923,
0.9936,0.9919,0.9910,0.9931,0.9915,0.9916,0.9930,0.9928,0.9926,0.9912,
0.9919,0.9943,0.9931,0.9946,0.9927,0.9914,0.9923,0.9928,0.9930,0.9922,
0.9928,0.9945,0.9921,0.9932,0.9937,0.9935,0.9937,0.9949,0.9939,0.9937,
0.9916,0.9960,0.9944,0.9907,0.9939,0.9917,0.9940,0.9930,0.9918,0.9943,
0.9864,0.9850,0.9975,0.9890,0.9897,0.9932,0.9913,0.9979,0.9949,0.9911,
0.9912,0.9823,0.9905,0.9888,0.9840,0.9936,0.9900,0.9908,0.9898,0.9881,
0.9909,0.9931,0.9921,0.9879,0.9983,0.9921,0.9917,0.9871,0.9888,0.9936,
0.9936,0.9944,0.9902,0.9889,0.9915,0.9926,0.9920,0.9968,0.9924,0.9925,
0.9920,0.9936,0.9936,0.9921,0.9922,0.9929,0.9934,0.9927,0.9921,0.9916,
0.9927,0.9943,0.9954,0.9924,0.9894,0.9922,0.9921,0.9943,0.9915,0.9911,
0.9916,0.9930,0.9924,0.9916,0.9926,0.9942,0.9940,0.9928,0.9922,0.9920,
0.9918,0.9919,0.9920,0.9927,0.9935,0.9927,0.9925,0.9924,0.9936,0.9934,
0.9929,0.9936,0.9926,0.9929,0.9925,0.9934,0.9939,0.9932,0.9926,0.9926,
0.9918,0.9925,0.9921,0.9922,0.9920,0.9924,0.9927,0.9925,0.9924,0.9932,
0.9927,0.9914,0.9916,0.9922,0.9920,0.9923,0.9922,0.9919,0.9923,0.9931,
0.9930,0.9930,0.9937,0.9942,0.9939,0.9933,0.9936,0.9935,0.9940,0.9941,
0.9936,0.9933,0.9936,0.9937,0.9938,0.9940,0.9940,0.9938,0.9934,0.9935,
0.9939,0.9943,0.9943,0.9933,0.9932,0.9932,0.9931,0.9933,0.9935,0.9936,
0.9934,0.9934,0.9933,0.9931,0.9937,0.9943,0.9944,0.9940,0.9926,0.9923,
0.9930,0.9933,0.9938,0.9937,0.9934,0.9933,0.9931,0.9932,0.9937,0.9934,
0.9928,0.9931,0.9933,0.9935,0.9937,0.9937,0.9936,0.9933,0.9934,0.9937,
0.9935,0.9932,0.9929,0.9933,0.9935,0.9932,0.9933,0.9934,0.9934,0.9934,
0.9933,0.9934,0.9934,0.9936,0.9935,0.9936,0.9938,0.9933,0.9931,0.9932,
0.9937,0.9938,0.9936,0.9933,0.9933,0.9934,0.9934,0.9935,0.9936,0.9935,
0.9934,0.9930,0.9930,0.9932,0.9932,0.9927,0.9933,0.9932,0.9932,0.9935,
0.9935,0.9935,0.9935,0.9935,0.9935,0.9933,0.9932,0.9928,0.9926,0.9928,
0.9926,0.9925,0.9928,0.9931,0.9931,0.9932,0.9928,0.9929,0.9927,0.9933,
0.9933,0.9931,0.9930,0.9926,0.9929,0.9933,0.9931,0.9930,0.9928,0.9929,
0.9932,0.9933,0.9932,0.9933,0.9935,0.9933,0.9936,0.9934,0.9931,0.9928,
0.9928,0.9934,0.9932,0.9927,0.9931,0.9935,0.9936,0.9931,0.9932,0.9934,
0.9933,0.9936,0.9931,0.9935,0.9933,0.9934,0.9934,0.9932,0.9939,0.9932,
0.9928,0.9929,0.9932,0.9932,0.9931,0.9933,0.9931,0.9933,0.9929,0.9933,
0.9932,0.9932,0.9931,0.9929,0.9924,0.9931,0.9929,0.9929,0.9929,0.9934,
0.9930,0.9935,0.9931,0.9932,0.9933,0.9928,0.9929,0.9930,0.9932,0.9932,
0.9931,0.9934,0.9932,0.9930,0.9928,0.9935,0.9928,0.9929,0.9931,0.9928,
0.9932,0.9931,0.9932,0.9934,0.9933,0.9935,0.9925,0.9923,0.9921,0.9921,
0.9919,0.9919,0.9926,0.9925,0.9919,0.9919,0.9924,0.9920,0.9926,0.9926,
0.9920,0.9922,0.9922,0.9922,0.9922,0.9923,0.9919,0.9922,0.9924,0.9924,
0.9918,0.9917,0.9920,0.9917,0.9919,0.9919,0.9923,0.9923,0.9918,0.9919,
0.9921,0.9919,0.9917,0.9919,0.9917,0.9920,0.9920,0.9919,0.9921,0.9918,
0.9919,0.9920,0.9921,0.9922,0.9922,0.9921,0.9922,0.9919,0.9919,0.9921,
0.9918,0.9921,0.9923,0.9923,0.9920,0.9924,0.9922,0.9919,0.9920,0.9921,
0.9918,0.9919,0.9918,0.9919,0.9920,0.9923,0.9922,0.9921,0.9922,0.9923,
0.9919,0.9922,0.9925,0.9921,0.9920,0.9920,0.9919,0.9918,0.9921,0.9922,
0.9920,0.9917,0.9918,0.9920,0.9919,0.9923,0.9923,0.9919,0.9919,0.9919,
0.9921,0.9920,0.9917,0.9917,0.9918,0.9920,0.9909,0.9909,0.9910,0.9911,
0.9911,0.9911,0.9909,0.9910,0.9912,0.9910,0.9908,0.9910,0.9912,0.9911,
0.9912,0.9912,0.9911,0.9912,0.9914,0.9913,0.9911,0.9909,0.9910,0.9911,
0.9911,0.9909,0.9908,0.9911,0.9908,0.9906,0.9909,0.9911,0.9910,0.9909,
0.9908,0.9911,0.9913,0.9910,0.9910,0.9911,0.9910,0.9909,0.9906,0.9908,
0.9909,0.9909,0.9912,0.9914,0.9910,0.9909,0.9899,0.9896,0.9896,0.9896,
0.9899,0.9901,0.9900,0.9899,0.9898,0.9897,0.9897,0.9898,0.9899,0.9898,
0.9898,0.9899,0.9900,0.9902,0.9898,0.9897,0.9899,0.9900,0.9900,0.9899,
0.9899,0.9903,0.9901,0.9898,0.9901,0.9906,0.9915,0.9919,0.9912,0.9908,
0.9907,0.9905,0.9905,0.9907,0.9906,0.9903,0.9899,0.9900,0.9900,0.9903,
0.9899,0.9892,0.9893,0.9893,0.9893,0.9895,0.9895,0.9897,0.9899,0.9902,
0.9903,0.9902,0.9905,0.9900,0.9896,0.9900,0.9897,0.9898,0.9900,0.9899,
0.9897,0.9892,0.9893,0.9899,0.9900,0.9897,0.9895,0.9896,0.9899,0.9900,
0.9901,0.9897,0.9898,0.9899,0.9899,0.9894,0.9900,0.9897,0.9894,0.9897,
0.9900,0.9896,0.9896,0.9895,0.9894,0.9897,0.9900,0.9902,0.9899,0.9897,
0.9898,0.9897,0.9897,0.9896,0.9893,0.9905,0.9906,0.9910,0.9908,0.9909,
0.9913,0.9911,0.9909,0.9905,0.9905,0.9908,0.9913,0.9914,0.9915,0.9913,
0.9913,0.9908,0.9915,0.9912,0.9909,0.9908,0.9911,0.9909,0.9916,0.9912,
0.9915,0.9917,0.9909,0.9909,0.9905,0.9906,0.9915,0.9908,0.9912,0.9911,
0.9911,0.9908,0.9909,0.9908,0.9910,0.9910,0.9908,0.9911,0.9915,0.9906,
0.9916,0.9910,0.9904,0.9909,0.9911,0.9911,0.9911,0.9907,0.9908,0.9903,
0.9905,0.9905,0.9909,0.9905,0.9908,0.9908,0.9916,0.9906,0.9910,0.9910,
0.9912,0.9905,0.9908,0.9909,0.9910,0.9912,0.9903,0.9910,0.9917,0.9911,
0.9912,0.9910,0.9908,0.9909,0.9914,0.9909,0.9912,0.9913,0.9909,0.9915,
0.9913,0.9907,0.9903,0.9909,0.9914,0.9913,0.9905,0.9902,0.9905,0.9904,
0.9911,0.9906,0.9911,0.9907,0.9908,0.9903,0.9906,0.9910,0.9906,0.9913,
0.9907,0.9906,0.9907,0.9907,0.9911,0.9909,0.9912,0.9909,0.9912,0.9907,
0.9907,0.9906,0.9905,0.9907,0.9909,0.9914,0.9912,0.9912,0.9924,0.9912,
0.9901,0.9907,0.9906,0.9912,0.9907,0.9910,0.9910,0.9911,0.9909,0.9907,
0.9911,0.9909,0.9909,0.9906,0.9908,0.9904,0.9907,0.9914,0.9915,0.9916,
0.9913,0.9904,0.9891,0.9892,0.9892,0.9886,0.9886,0.9889,0.9903,0.9914,
0.9906,0.9908,0.9923,0.9927,0.9922,0.9920,0.9925,0.9925,0.9922,0.9914,
0.9920,0.9912,0.9914,0.9908,0.9915,0.9909,0.9909,0.9918,0.9912,0.9909,
0.9903,0.9906,0.9911,0.9906,0.9907,0.9909,0.9908,0.9908,0.9907,0.9907,
0.9908,0.9913,0.9910,0.9910,0.9905,0.9908,0.9910,0.9913,0.9911,0.9908,
0.9912,0.9916,0.9910,0.9912,0.9909,0.9905,0.9901,0.9899,0.9892,0.9894,
0.9897,0.9899,0.9904,0.9906,0.9899,0.9897,0.9900,0.9897,0.9898,0.9901,
0.9901,0.9895,0.9894,0.9896,0.9896,0.9898,0.9903,0.9899,0.9896,0.9893,
0.9893,0.9897,0.9898,0.9900,0.9898,0.9890,0.9887,0.9891,0.9891,0.9892,
0.9893,0.9889,0.9897,0.9894,0.9900,0.9910,0.9913,0.9915,0.9902,0.9889,
0.9889,0.9893,0.9890,0.9887,0.9884,0.9882,0.9875,0.9877,0.9876,0.9874,
0.9873,0.9876,0.9878,0.9871,0.9874,0.9882,0.9880,0.9873,0.9877,0.9878,
0.9879,0.9887,0.9879,0.9882,0.9885,0.9877,0.9871,0.9874,0.9874,0.9873,
0.9887,0.9884,0.9874,0.9868,0.9869,0.9877,0.9869,0.9873,0.9879,0.9881,
0.9870,0.9875,0.9881,0.9879,0.9872,0.9876,0.9878,0.9869,0.9861,0.9863,
0.9875,0.9876,0.9878,0.9879,0.9866,0.9870,0.9869,0.9869,0.9867,0.9868,
0.9875,0.9872,0.9866,0.9874,0.9871,0.9865,0.9877,0.9879,0.9874,0.9870,
0.9855,0.9873,0.9877,0.9869,0.9864,0.9865,0.9876,0.9878,0.9873,0.9871,
0.9883,0.9881,0.9879,0.9871,0.9879,0.9878,0.9872,0.9873,0.9865,0.9858,
0.9857,0.9861,0.9863,0.9856,0.9860,0.9869,0.9871,0.9870,0.9866,0.9858,
0.9860,0.9866,0.9865,0.9870,0.9871,0.9883,0.9876,0.9872,0.9876,0.9882,
0.9867,0.9878,0.9875,0.9880,0.9880,0.9872,0.9872,0.9878,0.9877,0.9881,
0.9868,0.9877,0.9876,0.9872,0.9866,0.9881,0.9884,0.9884,0.9877,0.9869,
0.9870,0.9878,0.9870,0.9869,0.9872,0.9881,0.9869,0.9851,0.9853,0.9865,
0.9851,0.9872,0.9862,0.9864,0.9840,0.9831,0.9883,0.9901,0.9885,0.9842,
0.9859,0.9857,0.9865,0.9853,0.9850,0.9870,0.9840,0.9861,0.9860,0.9855,
0.9850,0.9845,0.9842,0.9851,0.9833,0.9828,0.9830,0.9830,0.9828,0.9857,
0.9861,0.9871,0.9860,0.9839,0.9842,0.9830,0.9824,0.9819,0.9809,0.9834,
0.9848,0.9836,0.9819,0.9830,0.9829,0.9841,0.9850,0.9829,0.9830,0.9825,
0.9820,0.9812,0.9827,0.9832,0.9840,0.9817,0.9807,0.9834,0.9817,0.9825,
0.9833,0.9844,0.9841,0.9832,0.9837,0.9829,0.9810,0.9820,0.9795,0.9798,
0.9790,0.9808,0.9819,0.9799,0.9797,0.9807,0.9787,0.9799,0.9810,0.9834,
0.9833,0.9834,0.9846,0.9773,0.9787,0.9809,0.9796,0.9804,0.9818,0.9803,
0.9794,0.9766,0.9824,0.9832,0.9837,0.9809,0.9772,0.9807,0.9804,0.9808,
0.9822,0.9796,0.9786,0.9798,0.9796,0.9801,0.9817,0.9796,0.9807,0.9819,
0.9805,0.9781,0.9793,0.9782,0.9807,0.9813,0.9792,0.9783,0.9782,0.9797,
0.9815,0.9811,0.9806,0.9774,0.9770,0.9800,0.9779,0.9786,0.9769,0.9794,
0.9814,0.9796,0.9757,0.9741,0.9796,0.9797,0.9802,0.9779,0.9752,0.9781,
0.9797,0.9813,0.9828,0.9802,0.9797,0.9807,0.9799,0.9784,0.9783,0.9801,
0.9784,0.9772,0.9782,0.9781,0.9785,0.9785,0.9778,0.9770,0.9783,0.9787,
0.9767,0.9780,0.9794,0.9785,0.9781,0.9782,0.9763,0.9783,0.9786,0.9762,
0.9773,0.9782,0.9770,0.9762,0.9765,0.9770,0.9763,0.9758,0.9766,0.9768,
0.9769,0.9757,0.9744,0.9741,0.9733,0.9751,0.9769,0.9773,0.9780,0.9774,
0.9727,0.9698,0.9730,0.9743,0.9757,0.9741,0.9714,0.9725,0.9711,0.9723,
0.9728,0.9714,0.9705,0.9700,0.9704,0.9702,0.9666,0.9640,0.9682,0.9741,
0.9761,0.9741,0.9704,0.9679,0.9694,0.9696,0.9678,0.9661,0.9675,0.9678,
0.9661,0.9649,0.9659,0.9656,0.9656,0.9658,0.9640,0.9641,0.9648,0.9636,
0.9644,0.9663,0.9652,0.9637,0.9624,0.9610,0.9624,0.9621,0.9613,0.9614,
0.9598,0.9603,0.9605,0.9615,0.9596,0.9621,0.9620,0.9623,0.9613,0.9619,
0.9596,0.9590,0.9607,0.9606,0.9606,0.9619,0.9584,0.9589,0.9596,0.9578,
0.9579,0.9567,0.9550,0.9571,0.9568,0.9545,0.9554,0.9575,0.9583,0.9561,
0.9550,0.9553,0.9542,0.9553,0.9576,0.9592,0.9573,0.9555,0.9543,0.9553,
0.9576,0.9563,0.9516,0.9534,0.9530,0.9527,0.9561,0.9533,0.9511,0.9528,
0.9505,0.9497,0.9535,0.9519,0.9543,0.9535,0.9534,0.9523,0.9529,0.9498,
0.9514,0.9500,0.9513,0.9502,0.9504,0.9506,0.9492,0.9459,0.9475,0.9507,
0.9455,0.9438,0.9457,0.9522,0.9503,0.9516,0.9518,0.9520,0.9503,0.9466,
0.9420,0.9501,0.9477,0.9451,0.9435,0.9456,0.9423,0.9441,0.9490,0.9454,
0.9479,0.9472,0.9461,0.9441,0.9474,0.9461,0.9441,0.9443,0.9491,0.9456,
0.9447,0.9517,0.9461,0.9455,0.9562,0.9505,0.9475,0.9456,0.9532,0.9517,
0.9451,0.9481,0.9529,0.9563,0.9528,0.9554,0.9528,0.9534,0.9505,0.9578,
0.9542,0.9523,0.9589,0.9591,0.9589,0.9593,0.9591,0.9566,0.9538,0.9579,
0.9561,0.9615,0.9581,0.9598,0.9629,0.9593,0.9586,0.9627,0.9620,0.9661,
0.9596,0.9638,0.9634,0.9657,0.9611,0.9677,0.9649,0.9636,0.9633,0.9646,
0.9688,0.9687,0.9645,0.9618,0.9696,0.9664,0.9628,0.9650,0.9649,0.9630,
0.9652,0.9657,0.9640,0.9669,0.9625,0.9612,0.9637,0.9686,0.9668,0.9663,
0.9685,0.9684,0.9652,0.9657,0.9612,0.9661,0.9670,0.9721,0.9717,0.9646,
0.9697,0.9683,0.9671,0.9674,0.9648,0.9705,0.9698,0.9658,0.9657,0.9675,
0.9664,0.9734,0.9714,0.9648,0.9676,0.9627,0.9630,0.9663,0.9712,0.9616,
0.9679,0.9634,0.9666,0.9641,0.9622,0.9667,0.9661,0.9650,0.9611,0.9631,
0.9664,0.9653,0.9653,0.9643,0.9656,0.9651,0.9615,0.9562,0.9620,0.9640,
0.9660,0.9658,0.9668,0.9654,0.9719,0.9659,0.9608,0.9641,0.9660,0.9629,
0.9579,0.9613,0.9637,0.9680,0.9616,0.9599,0.9596,0.9569,0.9602,0.9613,
0.9610,0.9587,0.9579,0.9523,0.9582,0.9648,0.9650,0.9668,0.9649,0.9557,
0.9548,0.9528,0.9581,0.9600,0.9608,0.9516,0.9453,0.9482,0.9564,0.9669,
0.9631,0.9506,0.9465,0.9487,0.9501,0.9554,0.9598,0.9562,0.9524,0.9523,
0.9586,0.9596,0.9515,0.9533,0.9532,0.9473,0.9413,0.9411,0.9502,0.9490,
0.9480,0.9485,0.9489,0.9530,0.9478,0.9482,0.9477,0.9444,0.9482,0.9531,
0.9598,0.9469,0.9375,0.9502,0.9569,0.9607,0.9601,0.9498,0.9434,0.9462,
0.9505,0.9555,0.9546,0.9486,0.9522,0.9462,0.9377,0.9406,0.9395,0.9439,
0.9485,0.9521,0.9425,0.9367,0.9468,0.9443,0.9449,0.9491,0.9438,0.9375,
0.9406,0.9374,0.9394,0.9497,0.9436,0.9408,0.9407,0.9514,0.9550,0.9480,
0.9440,0.9343,0.9322,0.9378,0.9414,0.9461,0.9353,0.9388,0.9433,0.9448,
0.9480,0.9361,0.9412,0.9464,0.9548,0.9525,0.9444,0.9441,0.9473,0.9430,
0.9377,0.9406,0.9384,0.9420,0.9531,0.9385,0.9390,0.9384,0.9318,0.9305,
0.9399,0.9441,0.9506,0.9489,0.9382,0.9319,0.9403,0.9448,0.9458,0.9378,
0.9446,0.9414,0.9265,0.9277,0.9285,0.9362,0.9326,0.9429,0.9441,0.9444,
0.9503,0.9456,0.9450,0.9525,0.9375,0.9284,0.9299,0.9322,0.9331,0.9326,
0.9327,0.9367,0.9360,0.9369,0.9491,0.9357,0.9339,0.9388,0.9406,0.9469,
0.9351,0.9382,0.9480,0.9368,0.9339,0.9382,0.9470,0.9410,0.9318,0.9355,
0.9529,0.9402,0.9238,0.9334,0.9401,0.9448,0.9471,0.9434,0.9406,0.9497,
0.9348,0.9349,0.9387,0.9601,0.9399,0.9434,0.9504,0.9499,0.9298,0.9505,
0.9621,0.9390,0.9501,0.9375,0.9217,0.9336,0.9376,0.9423,0.9462,0.9288,
0.9303,0.9339,0.9527,0.9371,0.9524,0.9458,0.9163,0.9445,0.9340,0.9393,
0.9365}; // end factory_calibrated_reflectance[wvl_clb] 10 wavelengths per line, 2251 total

/* fxm: Interpolate factory calibration of spectralon target to wavelength grid of current instrument (VNIR, SWIR) */

/* exposure_reference is exposure measured when pointing at spectralon reference target
   Camera exposed to natural light reflecting from reference target for standard exposure time accumulates exposure_reference counts in each channel
   Expected to be large fraction (assumed here to be fake_factory_calibrate_reflectance) of exposure_theoretical_maximum for white reflector
   However, grey reference reflector might be more optimal than white
   Plants have maximum reflectance of ~0.4 so calibrating at white not as accurate as calibrating near 0.4
   We hope Lemnatec tunes exposure time to achieve the greatest dynamic range, and thus precision, under a wide range of circumstances
   One tuning consideration is that maximum exposure for white reflector at noon is close to but does not exceed exposure_theoretical_maximum
   Other tuning considerations are possible... */
// 20160908: actual values are not yet available so use this guesstimate
*exposure_reference_guesstimate=ushort(factory_calibrated_reflectance_guesstimate*exposure_theoretical_maximum); // [cnt]
*maximum_plant_reflectance_guesstimate=0.37; // [frc]

// A perfect detector would measure no counts when aperture shut
*exposure_theoretical_minimum=ushort(0); // [cnt]

// A real detector exposed to darkness for standard exposure time accumulates exposure_dark counts in each channel
// 20160908: actual values are not yet available so we use this guesstimate
*exposure_dark_guesstimate=ushort(10); // [cnt]

xps_img_max=xps_img.max($y,$x);
xps_img_max@long_name="Maximum image exposure at each wavelength";
xps_img_max@units="Counts on scale from 0 to 2^16-1 = 65535";

// [cnt] Exposure from spectralon reference target
//xps_rfr[wavelength,x]=exposure_reference_guesstimate; // Produces reflectances too small by ~10^5
xps_rfr[wavelength,x]=ushort(xps_img_max*(factory_calibrated_reflectance_guesstimate/maximum_plant_reflectance_guesstimate));
xps_rfr@long_name="Exposure from spectralon reference target";
xps_rfr@units="Counts on scale from 0 to 2^16-1 = 65535";

xps_img_min=xps_img.min($y,$x);
xps_img_min@long_name="Minimum image exposure at each wavelength";
xps_img_min@units="Counts on scale from 0 to 2^16-1 = 65535";

// [cnt] Exposure from dark current image
xps_drk[wavelength,x]=xps_img_min*0.01;
xps_drk@long_name="Exposure from dark current image";
xps_drk@units="Counts on scale from 0 to 2^16-1 = 65535";

// [frc] Reflectance of spectralon reference target (from factory calibration)
// 20160908: must track this down, possibly add angular dependence
rfl_rfr_fct[wavelength]=factory_calibrated_reflectance_guesstimate;
rfl_rfr_fct@long_name="Reflectance of spectralon reference target (from factory calibration)";
rfl_rfr_fct@units="1";

// [cnt/cnt] Proportionality constant between factory-calibrated reflectance and current image and field calibration
// 20160908: No real reason to use or archive this
//rfl_img_prp=(xps_img-xps_drk)/(xps_rfr-xps_drk);

// [frc] = Reflectance of image (plant reflectance)
// 20160826: Pre-assigning to zero would create additional copy and increase required memory
// Instead use implicit casting, and overwrite attributes propagated from rfl_rfr_fct
//rfl_img[wavelength,y,x]=0.0f;
rfl_img=rfl_rfr_fct*(xps_img-xps_drk)/(xps_rfr-xps_drk);
rfl_img@long_name="Reflectance of image";
rfl_img@standard_name="surface_albedo";
rfl_img@units="1";

/* 20160908:
   Below this line is Environmental Logger information, now extraneous to hyperspectral calibration
   New calibration algorithm does not depend on measured irradiance...yet
   We could move this Environmental Logger code to (ncap2 version of) EL extractor */
// [nbr] Number of wavelengths in environmental sensor
*wvl_nvr_nbr=1024;
defdim("wvl_nvr",wvl_nvr_nbr);
wvl_nvr[wvl_nvr]=0.0f; // [m]
wvl_nvr@long_name="Wavelength of environmental sensor";
wvl_nvr@standard_name="sensor_band_central_radiation_wavelength";
wvl_nvr@units="meter";
wvl_nvr@provenance="EnvironmentalLogger calibration information from file S05673_08062015.IrradCal provided by TinoDornbusch and discussed here: https://github.com/terraref/reference-data/issues/30#issuecomment-217518434";

wvl_nvr={ // [nm] 10 wavelengths per line, 1024 total
337.70,338.16,338.62,339.07,339.53,339.98,340.44,340.89,341.35,341.80,
342.26,342.72,343.17,343.63,344.08,344.54,344.99,345.45,345.91,346.36,
346.82,347.28,347.73,348.19,348.64,349.10,349.56,350.01,350.47,350.93,
351.38,351.84,352.30,352.75,353.21,353.67,354.12,354.58,355.04,355.49,
355.95,356.41,356.86,357.32,357.78,358.23,358.69,359.15,359.61,360.06,
360.52,360.98,361.44,361.89,362.35,362.81,363.27,363.72,364.18,364.64,
365.10,365.55,366.01,366.47,366.93,367.39,367.84,368.30,368.76,369.22,
369.68,370.13,370.59,371.05,371.51,371.97,372.43,372.88,373.34,373.80,
374.26,374.72,375.18,375.64,376.09,376.55,377.01,377.47,377.93,378.39,
378.85,379.31,379.77,380.23,380.68,381.14,381.60,382.06,382.52,382.98,
383.44,383.90,384.36,384.82,385.28,385.74,386.20,386.66,387.12,387.58,
388.04,388.50,388.96,389.42,389.88,390.34,390.80,391.26,391.72,392.18,
392.64,393.10,393.56,394.02,394.48,394.94,395.40,395.86,396.32,396.78,
397.24,397.70,398.16,398.62,399.08,399.54,400.01,400.47,400.93,401.39,
401.85,402.31,402.77,403.23,403.69,404.16,404.62,405.08,405.54,406.00,
406.46,406.92,407.38,407.85,408.31,408.77,409.23,409.69,410.15,410.62,
411.08,411.54,412.00,412.46,412.93,413.39,413.85,414.31,414.77,415.24,
415.70,416.16,416.62,417.09,417.55,418.01,418.47,418.94,419.40,419.86,
420.32,420.79,421.25,421.71,422.17,422.64,423.10,423.56,424.03,424.49,
424.95,425.42,425.88,426.34,426.80,427.27,427.73,428.19,428.66,429.12,
429.58,430.05,430.51,430.98,431.44,431.90,432.37,432.83,433.29,433.76,
434.22,434.69,435.15,435.61,436.08,436.54,437.01,437.47,437.93,438.40,
438.86,439.33,439.79,440.25,440.72,441.18,441.65,442.11,442.58,443.04,
443.51,443.97,444.44,444.90,445.37,445.83,446.30,446.76,447.23,447.69,
448.16,448.62,449.09,449.55,450.02,450.48,450.95,451.41,451.88,452.34,
452.81,453.27,453.74,454.20,454.67,455.14,455.60,456.07,456.53,457.00,
457.46,457.93,458.40,458.86,459.33,459.79,460.26,460.73,461.19,461.66,
462.13,462.59,463.06,463.52,463.99,464.46,464.92,465.39,465.86,466.32,
466.79,467.26,467.72,468.19,468.66,469.12,469.59,470.06,470.52,470.99,
471.46,471.93,472.39,472.86,473.33,473.79,474.26,474.73,475.20,475.66,
476.13,476.60,477.07,477.53,478.00,478.47,478.94,479.40,479.87,480.34,
480.81,481.28,481.74,482.21,482.68,483.15,483.62,484.08,484.55,485.02,
485.49,485.96,486.42,486.89,487.36,487.83,488.30,488.77,489.23,489.70,
490.17,490.64,491.11,491.58,492.05,492.52,492.98,493.45,493.92,494.39,
494.86,495.33,495.80,496.27,496.74,497.21,497.68,498.14,498.61,499.08,
499.55,500.02,500.49,500.96,501.43,501.90,502.37,502.84,503.31,503.78,
504.25,504.72,505.19,505.66,506.13,506.60,507.07,507.54,508.01,508.48,
508.95,509.42,509.89,510.36,510.83,511.30,511.77,512.24,512.71,513.18,
513.65,514.12,514.59,515.06,515.54,516.01,516.48,516.95,517.42,517.89,
518.36,518.83,519.30,519.77,520.24,520.72,521.19,521.66,522.13,522.60,
523.07,523.54,524.01,524.49,524.96,525.43,525.90,526.37,526.84,527.32,
527.79,528.26,528.73,529.20,529.67,530.15,530.62,531.09,531.56,532.03,
532.51,532.98,533.45,533.92,534.40,534.87,535.34,535.81,536.29,536.76,
537.23,537.70,538.18,538.65,539.12,539.59,540.07,540.54,541.01,541.48,
541.96,542.43,542.90,543.38,543.85,544.32,544.80,545.27,545.74,546.22,
546.69,547.16,547.64,548.11,548.58,549.06,549.53,550.00,550.48,550.95,
551.42,551.90,552.37,552.84,553.32,553.79,554.27,554.74,555.21,555.69,
556.16,556.64,557.11,557.58,558.06,558.53,559.01,559.48,559.96,560.43,
560.90,561.38,561.85,562.33,562.80,563.28,563.75,564.23,564.70,565.18,
565.65,566.13,566.60,567.08,567.55,568.03,568.50,568.98,569.45,569.93,
570.40,570.88,571.35,571.83,572.30,572.78,573.25,573.73,574.20,574.68,
575.16,575.63,576.11,576.58,577.06,577.53,578.01,578.49,578.96,579.44,
579.91,580.39,580.87,581.34,581.82,582.29,582.77,583.25,583.72,584.20,
584.67,585.15,585.63,586.10,586.58,587.06,587.53,588.01,588.49,588.96,
589.44,589.92,590.39,590.87,591.35,591.82,592.30,592.78,593.26,593.73,
594.21,594.69,595.16,595.64,596.12,596.60,597.07,597.55,598.03,598.50,
598.98,599.46,599.94,600.41,600.89,601.37,601.85,602.33,602.80,603.28,
603.76,604.24,604.71,605.19,605.67,606.15,606.63,607.10,607.58,608.06,
608.54,609.02,609.50,609.97,610.45,610.93,611.41,611.89,612.37,612.85,
613.32,613.80,614.28,614.76,615.24,615.72,616.20,616.67,617.15,617.63,
618.11,618.59,619.07,619.55,620.03,620.51,620.99,621.47,621.94,622.42,
622.90,623.38,623.86,624.34,624.82,625.30,625.78,626.26,626.74,627.22,
627.70,628.18,628.66,629.14,629.62,630.10,630.58,631.06,631.54,632.02,
632.50,632.98,633.46,633.94,634.42,634.90,635.38,635.86,636.34,636.82,
637.30,637.78,638.26,638.74,639.22,639.70,640.18,640.67,641.15,641.63,
642.11,642.59,643.07,643.55,644.03,644.51,644.99,645.47,645.96,646.44,
646.92,647.40,647.88,648.36,648.84,649.32,649.81,650.29,650.77,651.25,
651.73,652.21,652.70,653.18,653.66,654.14,654.62,655.10,655.59,656.07,
656.55,657.03,657.51,658.00,658.48,658.96,659.44,659.92,660.41,660.89,
661.37,661.85,662.34,662.82,663.30,663.78,664.27,664.75,665.23,665.71,
666.20,666.68,667.16,667.64,668.13,668.61,669.09,669.58,670.06,670.54,
671.03,671.51,671.99,672.47,672.96,673.44,673.92,674.41,674.89,675.37,
675.86,676.34,676.82,677.31,677.79,678.28,678.76,679.24,679.73,680.21,
680.69,681.18,681.66,682.15,682.63,683.11,683.60,684.08,684.57,685.05,
685.53,686.02,686.50,686.99,687.47,687.95,688.44,688.92,689.41,689.89,
690.38,690.86,691.35,691.83,692.32,692.80,693.28,693.77,694.25,694.74,
695.22,695.71,696.19,696.68,697.16,697.65,698.13,698.62,699.10,699.59,
700.07,700.56,701.05,701.53,702.02,702.50,702.99,703.47,703.96,704.44,
704.93,705.41,705.90,706.39,706.87,707.36,707.84,708.33,708.81,709.30,
709.79,710.27,710.76,711.24,711.73,712.22,712.70,713.19,713.68,714.16,
714.65,715.13,715.62,716.11,716.59,717.08,717.57,718.05,718.54,719.03,
719.51,720.00,720.49,720.97,721.46,721.95,722.43,722.92,723.41,723.90,
724.38,724.87,725.36,725.84,726.33,726.82,727.31,727.79,728.28,728.77,
729.25,729.74,730.23,730.72,731.20,731.69,732.18,732.67,733.16,733.64,
734.13,734.62,735.11,735.59,736.08,736.57,737.06,737.55,738.03,738.52,
739.01,739.50,739.99,740.47,740.96,741.45,741.94,742.43,742.92,743.40,
743.89,744.38,744.87,745.36,745.85,746.34,746.82,747.31,747.80,748.29,
748.78,749.27,749.76,750.25,750.74,751.22,751.71,752.20,752.69,753.18,
753.67,754.16,754.65,755.14,755.63,756.12,756.61,757.10,757.58,758.07,
758.56,759.05,759.54,760.03,760.52,761.01,761.50,761.99,762.48,762.97,
763.46,763.95,764.44,764.93,765.42,765.91,766.40,766.89,767.38,767.87,
768.36,768.85,769.34,769.83,770.32,770.81,771.30,771.79,772.28,772.78,
773.27,773.76,774.25,774.74,775.23,775.72,776.21,776.70,777.19,777.68,
778.17,778.66,779.16,779.65,780.14,780.63,781.12,781.61,782.10,782.59,
783.09,783.58,784.07,784.56,785.05,785.54,786.03,786.53,787.02,787.51,
788.00,788.49,788.98,789.48,789.97,790.46,790.95,791.44,791.93,792.43,
792.92,793.41,793.90,794.39,794.89,795.38,795.87,796.36,796.86,797.35,
797.84,798.33,798.82,799.32,799.81,800.30,800.79,801.29,801.78,802.27,
802.77,803.26,803.75,804.24,804.74,805.23,805.72,806.22,806.71,807.20,
807.69,808.19,808.68,809.17,809.67,810.16,810.65,811.15,811.64,812.13,
812.63,813.12,813.61,814.11,814.60,815.09,815.59,816.08,816.57,817.07,
817.56,818.06,818.55,819.04,819.54,820.03,820.53,821.02,821.51,822.01,
822.50,823.00,823.49,823.98};
// Change EnvironmentalLogger wavelengths from nm to m (SI)
wvl_nvr*=1.0e-9; // [m]

// Compute bandwidth as difference between midpoints of adjacent band-centers
wvl_dlt[wvl_nvr]=0.0f;
wvl_dlt@long_name="Bandwidth of environmental sensor";
wvl_dlt@units="meter";
wvl_dlt@standard_name="bandwidth";
wvl_dlt@notes="Bandwidth, also called dispersion, is between 0.455-0.495 nm across all channels. Values computed as differences between midpoints of adjacent band-centers.";
*idx=wvl_dlt.size()-1;
*wvl_lft[wvl_nvr]=0.0;
*wvl_rgt[wvl_nvr]=0.0;
wvl_lft(1:idx)=0.5*(wvl_nvr(0:idx-1)+wvl_nvr(1:idx));
wvl_rgt(0:idx-1)=wvl_lft(1:idx);
wvl_lft(0)=wvl_nvr(0)-0.5*(wvl_nvr(1)-wvl_nvr(0));
wvl_rgt(idx)=wvl_nvr(idx)+0.5*(wvl_nvr(idx)-wvl_nvr(idx-1));
wvl_dlt=wvl_rgt-wvl_lft;

flx_sns[wvl_nvr]=0.0f;
flx_sns@long_name="Flux sensitivity of each band (irradiance per count)";
flx_sns@units="joule count-1";
flx_sns@provenance="EnvironmentalLogger calibration information from file S05673_08062015.IrradCal provided by TinoDornbusch and discussed here: https://github.com/terraref/reference-data/issues/30#issuecomment-217518434";
flx_sns={ // [uJ cnt-1] 10 sensitivities per line, 1024 total
2.14905162e-3,2.14905162e-3,2.13191329e-3,2.09958721e-3,2.07255014e-3,2.04042869e-3,2.01065201e-3,1.98247712e-3,1.95695595e-3,1.93084270e-3,
1.90570597e-3,1.87482001e-3,1.85556117e-3,1.83111292e-3,1.80493827e-3,1.78204243e-3,1.76011709e-3,1.74298970e-3,1.72493868e-3,1.70343113e-3,
1.68553722e-3,1.66631622e-3,1.65443041e-3,1.63642311e-3,1.61846215e-3,1.60545573e-3,1.59131286e-3,1.57713520e-3,1.56105571e-3,1.54524417e-3,
1.53346351e-3,1.51857527e-3,1.50523348e-3,1.49241475e-3,1.47961893e-3,1.46809459e-3,1.45371019e-3,1.44115770e-3,1.42656173e-3,1.41449893e-3,
1.40218325e-3,1.38727829e-3,1.37516400e-3,1.36250816e-3,1.34930545e-3,1.33658553e-3,1.32360948e-3,1.31037104e-3,1.29485640e-3,1.28218362e-3,
1.26643446e-3,1.25134745e-3,1.23774104e-3,1.22154062e-3,1.20610594e-3,1.19103569e-3,1.17634593e-3,1.16196432e-3,1.14706609e-3,1.13382928e-3,
1.11918389e-3,1.10556178e-3,1.09188557e-3,1.07918790e-3,1.06742601e-3,1.05718118e-3,1.04694473e-3,1.03659582e-3,1.02873900e-3,1.02288609e-3,
1.01628109e-3,1.01158157e-3,1.00762812e-3,1.00491506e-3,9.99889414e-4,9.95638736e-4,9.91223764e-4,9.86536043e-4,9.82378851e-4,9.75992983e-4,
9.68055921e-4,9.60360601e-4,9.52229616e-4,9.44288731e-4,9.35551583e-4,9.27778978e-4,9.19234295e-4,9.10434775e-4,9.02072493e-4,8.94082691e-4,
8.86054070e-4,8.80176269e-4,8.73884929e-4,8.67741565e-4,8.61294713e-4,8.55225782e-4,8.50034434e-4,8.44592095e-4,8.39026291e-4,8.32991645e-4,
8.27232672e-4,8.20422797e-4,8.12627476e-4,8.03944155e-4,7.93686106e-4,7.82697718e-4,7.71489658e-4,7.58484857e-4,7.47988099e-4,7.37636214e-4,
7.28366631e-4,7.19162810e-4,7.11125553e-4,7.03209565e-4,6.94909585e-4,6.86758690e-4,6.78942712e-4,6.70144668e-4,6.62797996e-4,6.54343779e-4,
6.46170305e-4,6.38872127e-4,6.30959379e-4,6.25264821e-4,6.19260059e-4,6.14223740e-4,6.09600378e-4,6.04109797e-4,5.99684341e-4,5.94762462e-4,
5.89358438e-4,5.84542583e-4,5.79374467e-4,5.76250247e-4,5.72012513e-4,5.68631187e-4,5.65821491e-4,5.62718648e-4,5.59116033e-4,5.55411029e-4,
5.51801247e-4,5.47598043e-4,5.43247327e-4,5.37762461e-4,5.33460619e-4,5.28878572e-4,5.23689536e-4,5.19266009e-4,5.14458405e-4,5.10751276e-4,
5.07003427e-4,5.03165882e-4,4.98966826e-4,4.96001001e-4,4.93715941e-4,4.90249980e-4,4.86771807e-4,4.83624709e-4,4.80476687e-4,4.76929878e-4,
4.74001018e-4,4.70608674e-4,4.66770209e-4,4.64581056e-4,4.61759438e-4,4.59189259e-4,4.57332260e-4,4.55348303e-4,4.53789335e-4,4.51997104e-4,
4.51229308e-4,4.49813718e-4,4.49043888e-4,4.48243809e-4,4.47227105e-4,4.45901662e-4,4.44320515e-4,4.42138136e-4,4.40911947e-4,4.38857020e-4,
4.36114912e-4,4.32791420e-4,4.29184734e-4,4.26039764e-4,4.23760025e-4,4.20638491e-4,4.17739943e-4,4.15334137e-4,4.13241033e-4,4.10672248e-4,
4.08480950e-4,4.07521131e-4,4.06620556e-4,4.05633162e-4,4.04394743e-4,4.02768826e-4,4.01579752e-4,4.00290096e-4,3.98392706e-4,3.96699174e-4,
3.94234388e-4,3.91851912e-4,3.89154416e-4,3.86231981e-4,3.83777232e-4,3.81168698e-4,3.78433645e-4,3.76298344e-4,3.74215227e-4,3.72197441e-4,
3.70207284e-4,3.68657365e-4,3.67545261e-4,3.66319403e-4,3.65206679e-4,3.63557693e-4,3.62294538e-4,3.61179418e-4,3.58947889e-4,3.56599608e-4,
3.53923148e-4,3.51224187e-4,3.48070600e-4,3.44364936e-4,3.40781769e-4,3.37471420e-4,3.33912295e-4,3.30235172e-4,3.26561393e-4,3.23282422e-4,
3.20050433e-4,3.17180477e-4,3.14219227e-4,3.11600742e-4,3.09493381e-4,3.07471257e-4,3.05484183e-4,3.03684277e-4,3.01998980e-4,3.00340107e-4,
2.98343918e-4,2.96867620e-4,2.94945050e-4,2.93219375e-4,2.91688135e-4,2.89922856e-4,2.87800025e-4,2.85461354e-4,2.83757039e-4,2.81377961e-4,
2.79552629e-4,2.77642310e-4,2.75503391e-4,2.73875335e-4,2.72347155e-4,2.70900748e-4,2.69293738e-4,2.67858074e-4,2.66460300e-4,2.65251110e-4,
2.64275292e-4,2.63248240e-4,2.62327379e-4,2.61579696e-4,2.60818456e-4,2.60002965e-4,2.58705340e-4,2.57752670e-4,2.56913992e-4,2.56361785e-4,
2.55265269e-4,2.54289030e-4,2.53369783e-4,2.52709129e-4,2.51737103e-4,2.50397300e-4,2.48911620e-4,2.47940106e-4,2.46958831e-4,2.46000402e-4,
2.44657610e-4,2.42959871e-4,2.41646677e-4,2.40071179e-4,2.38572274e-4,2.37125904e-4,2.35921992e-4,2.34980504e-4,2.34028683e-4,2.32572352e-4,
2.31160035e-4,2.29885626e-4,2.28995291e-4,2.28016467e-4,2.26725040e-4,2.25484801e-4,2.23893466e-4,2.22942513e-4,2.21397987e-4,2.19729430e-4,
2.18184785e-4,2.16237560e-4,2.14867776e-4,2.13119570e-4,2.11095792e-4,2.09431424e-4,2.07369328e-4,2.05197478e-4,2.02992714e-4,2.00995783e-4,
1.99040628e-4,1.97330365e-4,1.95128937e-4,1.92897050e-4,1.90828812e-4,1.88848992e-4,1.86812770e-4,1.85107403e-4,1.83851878e-4,1.81970227e-4,
1.80471463e-4,1.78981517e-4,1.77286120e-4,1.76392581e-4,1.75098596e-4,1.74137351e-4,1.73190515e-4,1.72166132e-4,1.71231374e-4,1.70366007e-4,
1.69568760e-4,1.68589267e-4,1.67791363e-4,1.66897578e-4,1.65888439e-4,1.65083935e-4,1.64157795e-4,1.63088458e-4,1.62054638e-4,1.60921204e-4,
1.59597998e-4,1.58591166e-4,1.57448762e-4,1.55975979e-4,1.54945634e-4,1.53768607e-4,1.52490862e-4,1.51237859e-4,1.50099128e-4,1.49111429e-4,
1.47998498e-4,1.47145525e-4,1.46192385e-4,1.45307609e-4,1.44594903e-4,1.43689016e-4,1.42978840e-4,1.42385947e-4,1.41618642e-4,1.41296459e-4,
1.40736609e-4,1.40128598e-4,1.39496377e-4,1.38800776e-4,1.38248154e-4,1.37619848e-4,1.37121202e-4,1.36531523e-4,1.35719098e-4,1.35125606e-4,
1.34189288e-4,1.33450058e-4,1.32766920e-4,1.31885017e-4,1.31122573e-4,1.30328488e-4,1.29426836e-4,1.28660144e-4,1.27935543e-4,1.27252022e-4,
1.26480762e-4,1.25668248e-4,1.24922118e-4,1.24410907e-4,1.23808009e-4,1.23163911e-4,1.22517652e-4,1.21996101e-4,1.21426745e-4,1.20795188e-4,
1.20351946e-4,1.19824156e-4,1.19435754e-4,1.19034938e-4,1.18434743e-4,1.18058836e-4,1.17753346e-4,1.17341202e-4,1.17001634e-4,1.16538566e-4,
1.16315189e-4,1.16025052e-4,1.15877025e-4,1.15561180e-4,1.15133517e-4,1.14836326e-4,1.14582204e-4,1.14243860e-4,1.14197033e-4,1.13911263e-4,
1.13780203e-4,1.13241434e-4,1.12847757e-4,1.12518590e-4,1.12240191e-4,1.12090644e-4,1.11898539e-4,1.11697770e-4,1.11478439e-4,1.11055915e-4,
1.11038903e-4,1.10892821e-4,1.10844792e-4,1.10832493e-4,1.10685454e-4,1.10585787e-4,1.10523459e-4,1.10538204e-4,1.10352101e-4,1.10342922e-4,
1.10281513e-4,1.10136790e-4,1.10034253e-4,1.10161106e-4,1.10100572e-4,1.10110098e-4,1.10080592e-4,1.09984173e-4,1.09845052e-4,1.09851854e-4,
1.09905915e-4,1.10028217e-4,1.10035987e-4,1.09960749e-4,1.09766410e-4,1.09785602e-4,1.09799006e-4,1.09935387e-4,1.09996957e-4,1.10015594e-4,
1.09970966e-4,1.09805155e-4,1.09719944e-4,1.09678392e-4,1.09725399e-4,1.09808313e-4,1.09636200e-4,1.09535133e-4,1.09295215e-4,1.09169349e-4,
1.09191375e-4,1.09233527e-4,1.09205113e-4,1.09120552e-4,1.09119671e-4,1.08973612e-4,1.08924114e-4,1.08891026e-4,1.08907229e-4,1.08986240e-4,
1.08900531e-4,1.08753082e-4,1.08703896e-4,1.08787039e-4,1.08795093e-4,1.08699656e-4,1.08837754e-4,1.08804051e-4,1.08825203e-4,1.08836245e-4,
1.08750606e-4,1.08911309e-4,1.08993157e-4,1.09019453e-4,1.08906882e-4,1.08830389e-4,1.08786024e-4,1.08648784e-4,1.08543831e-4,1.08526696e-4,
1.08346842e-4,1.08177325e-4,1.07894351e-4,1.07585013e-4,1.07355722e-4,1.07161797e-4,1.07018269e-4,1.06701081e-4,1.06490135e-4,1.06148921e-4,
1.05780669e-4,1.05519970e-4,1.05237804e-4,1.05018149e-4,1.04960672e-4,1.04759539e-4,1.04540409e-4,1.04335532e-4,1.04248329e-4,1.04080729e-4,
1.04091425e-4,1.04055083e-4,1.04023531e-4,1.03982955e-4,1.03897792e-4,1.03664565e-4,1.03597003e-4,1.03534202e-4,1.03538706e-4,1.03610086e-4,
1.03562393e-4,1.03382849e-4,1.03208570e-4,1.03080933e-4,1.03024256e-4,1.03051061e-4,1.03046453e-4,1.02968720e-4,1.02813488e-4,1.02603014e-4,
1.02234419e-4,1.02028022e-4,1.01905582e-4,1.01804529e-4,1.01678913e-4,1.01525915e-4,1.01235735e-4,1.01002510e-4,1.00753430e-4,1.00514078e-4,
1.00437680e-4,1.00426425e-4,1.00342652e-4,1.00324563e-4,1.00193735e-4,9.99614188e-5,9.97959450e-5,9.96635685e-5,9.95680633e-5,9.95295601e-5,
9.95419478e-5,9.93610409e-5,9.92005015e-5,9.89874238e-5,9.87621992e-5,9.86741797e-5,9.86446806e-5,9.87023188e-5,9.86904988e-5,9.87196887e-5,
9.86048564e-5,9.84391907e-5,9.83676057e-5,9.83207848e-5,9.84386405e-5,9.84955583e-5,9.85247638e-5,9.85229229e-5,9.84406010e-5,9.83803668e-5,
9.83439478e-5,9.83296520e-5,9.84439321e-5,9.85235870e-5,9.85655663e-5,9.84966496e-5,9.84488197e-5,9.84056559e-5,9.83206327e-5,9.81939782e-5,
9.83002829e-5,9.82246562e-5,9.82700124e-5,9.83010388e-5,9.82759501e-5,9.81680327e-5,9.80868465e-5,9.80081521e-5,9.80084773e-5,9.80201149e-5,
9.81387400e-5,9.80116911e-5,9.80144351e-5,9.79589533e-5,9.78046061e-5,9.76346492e-5,9.76720556e-5,9.76000615e-5,9.76940237e-5,9.76700649e-5,
9.76436554e-5,9.76217315e-5,9.75644547e-5,9.74582521e-5,9.73723677e-5,9.75158846e-5,9.76063227e-5,9.76576561e-5,9.78378613e-5,9.78764318e-5,
9.78355668e-5,9.79053556e-5,9.78971200e-5,9.79906854e-5,9.80966670e-5,9.83212609e-5,9.83661316e-5,9.85426549e-5,9.86024674e-5,9.86590075e-5,
9.86276988e-5,9.87354712e-5,9.87754605e-5,9.89135932e-5,9.91850242e-5,9.94027993e-5,9.94630471e-5,9.95331627e-5,9.95927355e-5,9.96449255e-5,
9.96738155e-5,9.97903713e-5,9.99867011e-5,1.00180641e-4,1.00305263e-4,1.00350675e-4,1.00337790e-4,1.00368296e-4,1.00386643e-4,1.00381686e-4,
1.00519126e-4,1.00708351e-4,1.00900376e-4,1.00985285e-4,1.01155946e-4,1.01232434e-4,1.01246029e-4,1.01294137e-4,1.01423141e-4,1.01638838e-4,
1.01812099e-4,1.01937894e-4,1.02167422e-4,1.02253729e-4,1.02424793e-4,1.02521930e-4,1.02690121e-4,1.02839311e-4,1.03089113e-4,1.03250475e-4,
1.03431580e-4,1.03716033e-4,1.03938607e-4,1.04117939e-4,1.04384106e-4,1.04529677e-4,1.04654582e-4,1.04814310e-4,1.05092692e-4,1.05413737e-4,
1.05740355e-4,1.06083661e-4,1.06308365e-4,1.06565438e-4,1.06629335e-4,1.06744210e-4,1.06882442e-4,1.07187881e-4,1.07381175e-4,1.07571985e-4,
1.07752337e-4,1.07958784e-4,1.08010861e-4,1.08075778e-4,1.08124883e-4,1.08257449e-4,1.08419171e-4,1.08593318e-4,1.08694174e-4,1.08884465e-4,
1.09042040e-4,1.09206302e-4,1.09350437e-4,1.09438760e-4,1.09607358e-4,1.09782787e-4,1.09955758e-4,1.10091358e-4,1.10285940e-4,1.10491229e-4,
1.10742419e-4,1.10907433e-4,1.10989206e-4,1.10994674e-4,1.11224947e-4,1.11275260e-4,1.11379372e-4,1.11598462e-4,1.11899867e-4,1.12232203e-4,
1.12446731e-4,1.12641100e-4,1.12842223e-4,1.13075513e-4,1.13342586e-4,1.13508149e-4,1.13820379e-4,1.14203203e-4,1.14490663e-4,1.14760307e-4,
1.15092754e-4,1.15469416e-4,1.15670149e-4,1.16009156e-4,1.16271820e-4,1.16580050e-4,1.16902429e-4,1.17308313e-4,1.17666409e-4,1.18021025e-4,
1.18417002e-4,1.18680029e-4,1.18865319e-4,1.19262047e-4,1.19437496e-4,1.19686615e-4,1.19978762e-4,1.20252739e-4,1.20473473e-4,1.20770056e-4,
1.21090033e-4,1.21331608e-4,1.21505469e-4,1.21699316e-4,1.21782412e-4,1.21974020e-4,1.22103237e-4,1.22231939e-4,1.22420471e-4,1.22581870e-4,
1.22711136e-4,1.22866496e-4,1.22913279e-4,1.23115711e-4,1.23199889e-4,1.23323819e-4,1.23461205e-4,1.23642315e-4,1.23796507e-4,1.24020468e-4,
1.24238753e-4,1.24422114e-4,1.24625589e-4,1.24860150e-4,1.24989076e-4,1.25232771e-4,1.25461347e-4,1.25751417e-4,1.26039690e-4,1.26363122e-4,
1.26586473e-4,1.26874300e-4,1.27211480e-4,1.27449080e-4,1.27810195e-4,1.28112243e-4,1.28496922e-4,1.28769318e-4,1.28988874e-4,1.29308334e-4,
1.29681533e-4,1.30081273e-4,1.30484797e-4,1.30834377e-4,1.31195470e-4,1.31542514e-4,1.31971306e-4,1.32327207e-4,1.32671516e-4,1.33163904e-4,
1.33602896e-4,1.34007504e-4,1.34403545e-4,1.34785880e-4,1.35232311e-4,1.35920055e-4,1.36371634e-4,1.36941354e-4,1.37497873e-4,1.38329979e-4,
1.38981090e-4,1.39719676e-4,1.40596483e-4,1.41573836e-4,1.42701064e-4,1.43912407e-4,1.45127755e-4,1.46710702e-4,1.48201619e-4,1.49963009e-4,
1.51809861e-4,1.53750193e-4,1.55815317e-4,1.57693897e-4,1.59629003e-4,1.61541153e-4,1.63306339e-4,1.64888939e-4,1.66286077e-4,1.67668695e-4,
1.68815611e-4,1.69629768e-4,1.70307707e-4,1.70592642e-4,1.70837390e-4,1.70905017e-4,1.70730284e-4,1.70560321e-4,1.70279811e-4,1.69980969e-4,
1.69683568e-4,1.69203059e-4,1.68858534e-4,1.68509619e-4,1.68194840e-4,1.67681333e-4,1.67199028e-4,1.66717819e-4,1.66199767e-4,1.65735840e-4,
1.65420369e-4,1.65032314e-4,1.64890865e-4,1.64715724e-4,1.64497541e-4,1.64412240e-4,1.64324793e-4,1.64276994e-4,1.64155537e-4,1.64020542e-4,
1.64016963e-4,1.63898890e-4,1.64032362e-4,1.64045267e-4,1.64195414e-4,1.64285742e-4,1.64460407e-4,1.64661763e-4,1.64738587e-4,1.64862909e-4,
1.65076816e-4,1.65024997e-4,1.65162453e-4,1.65237474e-4,1.65562552e-4,1.65709225e-4,1.66142295e-4,1.66413982e-4,1.66803643e-4,1.67161297e-4,
1.67479188e-4,1.67667097e-4,1.67864791e-4,1.68139958e-4,1.68233347e-4,1.68368232e-4,1.68734109e-4,1.68895921e-4,1.69306212e-4,1.69651966e-4,
1.69946857e-4,1.70444809e-4,1.70732732e-4,1.71135157e-4,1.71231516e-4,1.71550211e-4,1.71696417e-4,1.71827084e-4,1.72142950e-4,1.72525391e-4,
1.72856514e-4,1.73390715e-4,1.73767822e-4,1.74328441e-4,1.74893554e-4,1.75395641e-4,1.75742115e-4,1.76164298e-4,1.76419331e-4,1.76746627e-4,
1.76913681e-4,1.77372254e-4,1.77897899e-4,1.78453513e-4,1.79169646e-4,1.79727818e-4,1.80409802e-4,1.81135436e-4,1.81693575e-4,1.82304987e-4,
1.82840211e-4,1.83218701e-4,1.83686875e-4,1.84158245e-4,1.84720710e-4,1.85261670e-4,1.86044882e-4,1.86910627e-4,1.87744111e-4,1.88640197e-4,
1.89536957e-4,1.90373887e-4,1.91044376e-4,1.91770554e-4,1.92334227e-4,1.93008156e-4,1.93752580e-4,1.94471581e-4,1.95272205e-4,1.96159946e-4,
1.97179878e-4,1.98147132e-4,1.99205315e-4,2.00512171e-4,2.01401775e-4,2.02350741e-4,2.03121965e-4,2.03880283e-4,2.04553652e-4,2.05224749e-4,
2.05896678e-4,2.06741041e-4,2.07620395e-4,2.08540576e-4,2.09373829e-4,2.10385794e-4,2.11266605e-4,2.12109107e-4,2.12682109e-4,2.13305338e-4,
2.13902214e-4,2.14484164e-4,2.14843762e-4,2.15242449e-4,2.15718844e-4,2.16421684e-4,2.17195290e-4,2.18005590e-4,2.18962077e-4,2.19991471e-4,
2.20919919e-4,2.21546974e-4,2.22053928e-4,2.22555080e-4,2.23237798e-4,2.23532485e-4,2.23996613e-4,2.24501430e-4,2.25173147e-4,2.25737767e-4,
2.26423767e-4,2.27365037e-4,2.28449699e-4,2.29400621e-4,2.30377333e-4,2.31057918e-4,2.31964152e-4,2.32623742e-4,2.33166196e-4,2.33650080e-4,
2.34105936e-4,2.34878659e-4,2.35394209e-4,2.36099367e-4,2.37123530e-4,2.38223666e-4,2.39309613e-4,2.40405595e-4,2.41495657e-4,2.42458496e-4,
2.43313474e-4,2.44175726e-4,2.44734401e-4,2.45486851e-4,2.45993980e-4,2.46800743e-4,2.47463201e-4,2.48445219e-4,2.49488279e-4,2.50569021e-4,
2.51747840e-4,2.52951109e-4,2.54188859e-4,2.55386833e-4,2.56298369e-4,2.57479006e-4,2.58213101e-4,2.59065147e-4,2.60018887e-4,2.61076885e-4,
2.62283407e-4,2.63904910e-4,2.65792030e-4,2.67956880e-4,2.70494493e-4,2.73225853e-4,2.76170072e-4,2.79055057e-4,2.81984548e-4,2.88500954e-4,
2.89109910e-4,2.93129400e-4,2.92536512e-4,2.92536512e-4};
// Change flux sensitivity from [uJ cnt-1] to [J cnt-1] (SI)
flx_sns*=1.0e-6; // [J cnt-1]

if(0){
  // Old ncap2 script that converted GDAL-prodoced rasters into a single 3D image cube
  if(!exists(wvl_nbr)) *wvl_nbr=926; // [nbr] SWIR camera has 926 bands

  defdim("wavelength",wvl_nbr);
  exposure[wavelength,x,y]=0.0f;
  exposure@long_name="Fractional exposure";
  exposure@meaning="Ratio of actual to fully exposed (saturated) channel";
  exposure@units="fraction";
  set_miss(exposure,Band1@_FillValue);
  wavelength[wavelength]=0.0f;
  wavelength@long_name="Wavelength";
  wavelength@units="nanometer";

  for(*wvl_idx=1;wvl_idx<=wvl_nbr;wvl_idx++){
    // Current variable has name produced by gdal_translate
    @var_crr=snprint(wvl_idx,"Band%d");
    @att_crr=snprint(wvl_idx,"Band%d@wavelength");
    if(flg_typ == flg_tst) print(@var_crr,"%s ");

    // Copy band 2D raster into 3D image hypercube
    exposure((wvl_idx-1),:,:)=*@var_crr;

    // Copy wavelength attribute into wavelength coordinate
    wavelength(wvl_idx-1)=*@att_crr;
 } // !wvl_idx

  // Debugging sanity check: Ensure, e.g., Band10 minus tenth band is zero
  if(flg_typ == flg_tst){
    err_chk10=(Band10-exposure(9,:,:)).total();
    err_chk300=(Band300-exposure(299,:,:)).total();
    err_chk926=(Band926-exposure(925,:,:)).total();
    print(err_chk10);
    print(err_chk300);
    print(err_chk926);
  } // !flg_typ

} // !0
